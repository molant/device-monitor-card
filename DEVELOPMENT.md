# Development Guide - Device Monitor Card

This guide explains the development workflow, build process, and project structure.

## Project Structure

```
device-monitor-card/
├── src/                          # Source files (edit these)
│   ├── device-monitor-card.js   # Main card source code
│   └── translations/             # Translation JSON files
│       ├── en.json              # English translations
│       ├── es.json              # Spanish translations
│       └── de.json              # German translations
├── dist/                         # Built files (generated, do not edit)
│   └── device-monitor-card.js   # Built file with embedded translations
├── scripts/                      # Build and release scripts
│   ├── build.sh                 # Build script (embeds translations)
│   ├── create-release.sh        # Create production release
│   ├── create-prerelease.sh     # Create pre-release for testing
│   └── delete-prerelease.sh     # Delete pre-release
├── CHANGELOG.md                  # Version history
├── DEVELOPMENT.md                # This file
└── README.md                     # User documentation
```

## Development Workflow

### 1. Making Changes

Edit files in the `src/` directory:
- **JavaScript code**: `src/device-monitor-card.js`
- **Translations**: `src/translations/*.json`

**Important**: Never edit files in `dist/` directly - they are generated by the build process.

### 2. Building

The build process embeds all translation files into the JavaScript for single-file deployment:

```bash
npm run build
```

Or use the bash script directly:
```bash
./scripts/build.js
```

This creates `dist/device-monitor-card.js` with:
- All translations embedded as a JavaScript object
- Synchronous translation loading (no fetch required)
- Ready for HACS deployment

You can also run the full test (build + syntax check):
```bash
npm test
```

### 3. Testing Locally

#### Option A: Test with Home Assistant

1. Build the card: `./scripts/build.sh`
2. Copy `dist/device-monitor-card.js` to your Home Assistant:
   ```bash
   cp dist/device-monitor-card.js <ha-config>/www/community/device-monitor-card/
   ```
3. Hard refresh your browser (Ctrl+F5 or Cmd+Shift+R)
4. Test the card functionality

#### Option B: Create a Pre-release

Pre-releases are great for testing before official releases:

```bash
npm run prerelease
```

Or use the script directly:
```bash
./scripts/create-prerelease.sh
```

This will:
1. Run the build script
2. Create a GitHub pre-release with timestamp
3. Allow installation via HACS for testing

To delete a pre-release:
```bash
./scripts/delete-prerelease.sh
```

### 4. Adding Translations

To add a new language:

1. Copy an existing translation file:
   ```bash
   cp src/translations/en.json src/translations/fr.json
   ```

2. Translate all values (keep keys unchanged):
   ```json
   {
     "editor": {
       "title": "Titre",
       "title_description": "Texte du titre de la carte",
       ...
     }
   }
   ```

3. Build and test:
   ```bash
   ./scripts/build.sh
   ```

4. The new language will be automatically embedded and available

## Release Process

### Creating a Release

Releases use semantic versioning based on conventional commits:

```bash
npm run release
```

Or use the script directly:
```bash
./scripts/create-release.sh
```

This script will:
1. Analyze commits since last release (feat, fix, breaking)
2. Determine version bump (major, minor, or patch)
3. Update version numbers in all files
4. **Run the build script** to generate `dist/device-monitor-card.js`
5. Update CHANGELOG.md
6. Create a git commit and tag
7. Push to GitHub
8. Create a GitHub release

### Commit Message Format

Use conventional commits for automatic versioning:

- `feat: add new feature` → Minor version bump (1.2.0 → 1.3.0)
- `fix: bug fix` → Patch version bump (1.2.0 → 1.2.1)
- `breaking: breaking change` → Major version bump (1.2.0 → 2.0.0)
- `misc: other changes` → Excluded from changelog

### Version Updates

The release script updates versions in:
- `package.json`
- `src/device-monitor-card.js` (@ version comment and CARD_VERSION constant)
- `CHANGELOG.md`

Then runs the build script to generate `dist/device-monitor-card.js` with the updated version.

## Build Script Details

The `scripts/build.js` Node.js script (called via `npm run build`) performs these steps:

1. **Validates** that source files exist
2. **Reads** all `src/translations/*.json` files
3. **Creates** an embedded JavaScript object:
   ```javascript
   const EMBEDDED_TRANSLATIONS = {
     'en': { ...en translations... },
     'es': { ...es translations... },
     'de': { ...de translations... }
   };
   ```
4. **Replaces** the async fetch-based LocalizationHelper with a synchronous version
5. **Outputs** to `dist/device-monitor-card.js`

### Why Embed Translations?

Embedding translations solves several issues:
- **HACS compatibility**: Single file deployment, no directory structure issues
- **No fetch failures**: Translations are always available
- **Faster loading**: No network requests needed
- **Offline support**: Works without network access

## HACS Deployment

The `hacs.json` configuration points to `dist/device-monitor-card.js`:

```json
{
  "name": "Device Monitor Card",
  "filename": "device-monitor-card.js",
  "content_in_root": false,
  "homeassistant": "2024.1.0"
}
```

With `content_in_root: false`, HACS looks in the `dist/` directory and deploys `device-monitor-card.js` to:
```
<ha-config>/www/community/device-monitor-card/device-monitor-card.js
```

## Troubleshooting

### Build fails with "src/device-monitor-card.js not found"
Make sure you're running the build script from the repository root, or that the source files exist in `src/`.

### Translations not showing after build
1. Check that translation files exist in `src/translations/*.json`
2. Verify JSON syntax is valid: `jq . src/translations/en.json`
3. Rebuild: `./scripts/build.sh`
4. Hard refresh browser

### HACS not updating
1. In HACS, go to the card settings
2. Click "Redownload"
3. Hard refresh browser (Ctrl+F5 or Cmd+Shift+R)

## Contributing

When contributing:
1. Edit files in `src/` only
2. Follow conventional commit format
3. Test with `./scripts/build.sh` and pre-releases
4. Ensure all translations are complete
5. Update CHANGELOG.md if needed (or let release script do it)

## Code Style

- Use 2-space indentation
- Use single quotes for strings
- Use template literals for multi-line strings
- Add comments for complex logic
- Follow existing code patterns

## Questions?

See the main [README.md](README.md) for user documentation, or open an issue on GitHub.
